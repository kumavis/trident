{"version":3,"sources":["../src/runtime/loadQuickJsModule.ts","../src/runtime/QuickJsWasmRuntime.ts","../src/vm/QuickJsForkableVm.ts","../src/index.ts"],"sourcesContent":["import type { QuickJsValue } from \"../types.ts\";\n\nexport interface QuickJsModule {\n  HEAP8: Int8Array;\n  HEAPU8: Uint8Array;\n  memory: WebAssembly.Memory;\n  _malloc(size: number): number;\n  _free(ptr: number): void;\n  _qjs_init_runtime(): void;\n  _qjs_eval_utf8(ptr: number, len: number): QuickJsValue;\n  _qjs_call_function(namePtr: number, nameLen: number, args: QuickJsValue[]): QuickJsValue;\n  _qjs_post_restore?(): void;\n  _qjs_get_runtime_ptr(): number;\n  _QTS_RuntimeEnableInterruptHandler(runtimePtr: number): void;\n  _QTS_RuntimeDisableInterruptHandler(runtimePtr: number): void;\n  _QTS_NewFunction(ctx: number, funcId: number, name: string): number;\n  _QTS_ArgvGetJSValueConstPointer(argv: number, index: number): number;\n}\n\nexport type QuickJsModuleFactory = (imports?: Record<string, unknown>) => Promise<QuickJsModule>;\n\n// Global map to track interrupt state per runtime pointer\nexport const runtimeInterruptState = new Map<\n  number,\n  { counter: number; limit: number }\n>();\n\n// Global map to store host functions by ID\nexport const hostFunctionRegistry = new Map<number, (...args: any[]) => any>();\nlet nextFunctionId = 1;\n\n// Export function to register host functions\nexport function registerHostFunction(func: (...args: any[]) => any): number {\n  const id = nextFunctionId++;\n  hostFunctionRegistry.set(id, func);\n  return id;\n}\n\n// Export function to unregister host functions\nexport function unregisterHostFunction(id: number): void {\n  hostFunctionRegistry.delete(id);\n}\n\n// Global shouldInterrupt callback that checks the map\n// Note: The WASM callback signature is (_unused, runtimePtr)\nfunction globalShouldInterrupt(_unused: unknown, runtimePtr: number): boolean {\n  const state = runtimeInterruptState.get(runtimePtr);\n  if (!state) {\n    return false;\n  }\n  state.counter++;\n  return state.counter > state.limit;\n}\n\nexport async function loadQuickJsModule(): Promise<QuickJsModule> {\n  // Don't cache - create a fresh module each time with callbacks\n  const factory = await importQuickJsModuleFactory();\n  const imports = {\n    callbacks: {\n      shouldInterrupt: globalShouldInterrupt,\n      callFunction: (...args: any[]) => {\n        // This will be set by the augmented module after it's initialized\n        if (typeof (globalThis as any).__trident_host_function_callback === 'function') {\n          return (globalThis as any).__trident_host_function_callback(...args);\n        }\n        throw new Error('Host function callback handler not initialized');\n      },\n    },\n  };\n  return factory(imports);\n}\n\nasync function importQuickJsModuleFactory(): Promise<QuickJsModuleFactory> {\n  // TODO: need a better way of distributing the wasm files\n  const isBuiltArtifact = /[/\\\\]dist[/\\\\]/.test(import.meta.url);\n  const wasmRelativePath = isBuiltArtifact ? \"./wasm/quickjs.mjs\" : \"../wasm/quickjs.mjs\";\n  const quickJsUrl = new URL(wasmRelativePath, import.meta.url);\n  const moduleNamespace = (await import(quickJsUrl.href)) as {\n    default?: QuickJsModuleFactory;\n    QuickJsModuleFactory?: QuickJsModuleFactory;\n    factory?: QuickJsModuleFactory;\n  };\n  const factory =\n    moduleNamespace.default ?? moduleNamespace.QuickJsModuleFactory ?? moduleNamespace.factory;\n  if (!factory) {\n    throw new Error(\"quickjs.mjs does not export a default module factory\");\n  }\n  return factory;\n}\n\n","import { loadQuickJsModule, runtimeInterruptState } from \"./loadQuickJsModule.ts\";\nimport type { QuickJsModule } from \"./loadQuickJsModule.ts\";\nimport type { QuickJsValue } from \"../types.ts\";\n\nconst encoder = new TextEncoder();\n\ninterface QuickJsRuntimeCreateOptions {\n  initializeRuntime?: boolean;\n  maxCycles?: number;\n}\n\nexport class QuickJsWasmRuntime {\n  private readonly module: QuickJsModule;\n  private readonly maxCycles: number | undefined;\n  private runtimePtr: number = 0;\n\n  private constructor(module: QuickJsModule, maxCycles?: number) {\n    this.module = module;\n    this.maxCycles = maxCycles;\n  }\n\n  static async create(\n    options: QuickJsRuntimeCreateOptions = {}\n  ): Promise<QuickJsWasmRuntime> {\n    const quickJsModule = await loadQuickJsModule();\n    if (options.initializeRuntime !== false) {\n      quickJsModule._qjs_init_runtime();\n    }\n    const runtime = new QuickJsWasmRuntime(quickJsModule, options.maxCycles);\n    \n    // Get the runtime pointer and set up interrupt handler\n    runtime.runtimePtr = quickJsModule._qjs_get_runtime_ptr();\n    \n    // Always initialize interrupt state for cycle tracking\n    runtimeInterruptState.set(runtime.runtimePtr, {\n      counter: 0,\n      limit: options.maxCycles ?? Infinity,\n    });\n    \n    // Only enable interrupt handler if we have a limit\n    if (options.maxCycles !== undefined) {\n      quickJsModule._QTS_RuntimeEnableInterruptHandler(runtime.runtimePtr);\n    }\n    \n    return runtime;\n  }\n\n  getMemoryView(): Uint8Array {\n    return this.module.HEAPU8;\n  }\n\n  takeSnapshot(): Uint8Array {\n    const view = this.getMemoryView();\n    const snapshot = new Uint8Array(view.length);\n    snapshot.set(view);\n    return snapshot;\n  }\n\n  restoreSnapshot(snapshot: Uint8Array): void {\n    const view = this.getMemoryView();\n    if (snapshot.length !== view.length) {\n      throw new Error(\"Snapshot size mismatch\");\n    }\n    view.set(snapshot);\n    if (typeof this.module._qjs_post_restore === \"function\") {\n      this.module._qjs_post_restore();\n    }\n  }\n\n  evalUtf8(source: string, callMaxCycles?: number): QuickJsValue {\n    const { result } = this.evalUtf8WithMetrics(source, callMaxCycles);\n    return result;\n  }\n\n  evalUtf8WithMetrics(source: string, callMaxCycles?: number): { result: QuickJsValue; cycleCount: number } {\n    // Reset interrupt counter and set limit before each eval\n    const state = runtimeInterruptState.get(this.runtimePtr);\n    if (state) {\n      state.counter = 0;\n      state.limit = callMaxCycles ?? this.maxCycles ?? Infinity;\n    }\n    \n    const result = this.invokeWithString(source, (ptr, len) => {\n      return this.module._qjs_eval_utf8(ptr, len);\n    });\n    \n    const cycleCount = state ? state.counter : 0;\n    return { result, cycleCount };\n  }\n\n  callFunctionUtf8(functionName: string, args: QuickJsValue[], callMaxCycles?: number): QuickJsValue {\n    const { result } = this.callFunctionUtf8WithMetrics(functionName, args, callMaxCycles);\n    return result;\n  }\n\n  callFunctionUtf8WithMetrics(functionName: string, args: QuickJsValue[], callMaxCycles?: number): { result: QuickJsValue; cycleCount: number } {\n    // Reset interrupt counter and set limit before each function call\n    const state = runtimeInterruptState.get(this.runtimePtr);\n    if (state) {\n      state.counter = 0;\n      state.limit = callMaxCycles ?? this.maxCycles ?? Infinity;\n    }\n    \n    const result = this.invokeWithString(functionName, (namePtr, nameLen) =>\n      this.module._qjs_call_function(namePtr, nameLen, args)\n    );\n    \n    const cycleCount = state ? state.counter : 0;\n    return { result, cycleCount };\n  }\n\n  private invokeWithString<T>(value: string, fn: (ptr: number, len: number) => T): T {\n    const { ptr, len } = this.writeString(value);\n    try {\n      return fn(ptr, len);\n    } finally {\n      this.module._free(ptr);\n    }\n  }\n\n  private writeString(value: string): { ptr: number; len: number } {\n    const bytes = encoder.encode(value);\n    const ptr = this.module._malloc(bytes.length);\n    this.module.HEAPU8.set(bytes, ptr);\n    return { ptr, len: bytes.length };\n  }\n\n}\n\n","import { QuickJsWasmRuntime } from \"../runtime/QuickJsWasmRuntime.ts\";\nimport type { CreateVmOptions, EvalOptions, EvalResult, ForkOptions, ForkableVm, QuickJsObject, QuickJsValue } from \"../types.ts\";\n\nexport class QuickJsForkableVm implements ForkableVm {\n  private busy = false;\n  private disposed = false;\n  private readonly runtime: QuickJsWasmRuntime;\n  private readonly options: CreateVmOptions;\n\n  constructor(runtime: QuickJsWasmRuntime, options: CreateVmOptions = {}) {\n    this.runtime = runtime;\n    this.options = options;\n  }\n\n  static async create(options: CreateVmOptions = {}): Promise<QuickJsForkableVm> {\n    const runtime = await QuickJsWasmRuntime.create({\n      maxCycles: options.maxCycles,\n    });\n    return new QuickJsForkableVm(runtime, options);\n  }\n\n  get globalThis(): QuickJsObject {\n    return this.withExclusiveAccessSync(() => this.runtime.evalUtf8(\"globalThis\") as QuickJsObject);\n  }\n\n  eval(code: string, options?: EvalOptions): QuickJsValue {\n    return this.withExclusiveAccessSync(() => this.runtime.evalUtf8(code, options?.maxCycles));\n  }\n\n  evalWithMetrics(code: string, options?: EvalOptions): EvalResult {\n    return this.withExclusiveAccessSync(() => this.runtime.evalUtf8WithMetrics(code, options?.maxCycles));\n  }\n\n  callFunction(name: string, ...args: QuickJsValue[]): QuickJsValue {\n    return this.withExclusiveAccessSync(() => this.runtime.callFunctionUtf8(name, args));\n  }\n\n  callFunctionWithMetrics(name: string, ...args: QuickJsValue[]): EvalResult {\n    return this.withExclusiveAccessSync(() => this.runtime.callFunctionUtf8WithMetrics(name, args));\n  }\n\n  async fork(options?: ForkOptions): Promise<ForkableVm> {\n    return this.withExclusiveAccessAsync(async () => {\n      const snapshot = this.runtime.takeSnapshot();\n      const childMaxCycles = options?.maxCycles !== undefined ? options.maxCycles : this.options.maxCycles;\n      const childRuntime = await QuickJsWasmRuntime.create({\n        initializeRuntime: false,\n        maxCycles: childMaxCycles,\n      });\n      childRuntime.restoreSnapshot(snapshot);\n      const childOptions: CreateVmOptions = {\n        ...this.options,\n        maxCycles: childMaxCycles,\n      };\n      return new QuickJsForkableVm(childRuntime, childOptions);\n    });\n  }\n\n  dispose(): void {\n    this.withExclusiveAccessSync(() => {\n      this.disposed = true;\n    });\n  }\n\n  private async withExclusiveAccessAsync<T>(fn: () => Promise<T>): Promise<T> {\n    this.throwIfUnavailable();\n    if (this.busy) {\n      throw new Error(\"VM operation already in progress\");\n    }\n    this.busy = true;\n    try {\n      return await fn();\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  private withExclusiveAccessSync<T>(fn: () => T): T {\n    this.throwIfUnavailable();\n    if (this.busy) {\n      throw new Error(\"VM operation already in progress\");\n    }\n    this.busy = true;\n    try {\n      return fn();\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  private throwIfUnavailable(): void {\n    if (this.disposed) {\n      throw new Error(\"VM has been disposed\");\n    }\n  }\n\n}\n\n","import { QuickJsForkableVm } from \"./vm/QuickJsForkableVm.ts\";\nimport type { CreateVmOptions, ForkableVm } from \"./types.ts\";\n\nexport { QuickJsWasmRuntime } from \"./runtime/QuickJsWasmRuntime.ts\";\nexport type { QuickJsValue, QuickJsFunction, QuickJsObject, ForkableVm, CreateVmOptions } from \"./types.ts\";\n\nexport async function createForkableVm(options: CreateVmOptions = {}): Promise<ForkableVm> {\n  return QuickJsForkableVm.create(options);\n}\n\nexport async function createPreloadedVm(\n  bootstrapCode: string,\n  options: CreateVmOptions = {}\n): Promise<ForkableVm> {\n  const vm = await createForkableVm(options);\n  try {\n    vm.eval(bootstrapCode);\n    return vm;\n  } catch (error) {\n    vm.dispose();\n    throw error;\n  }\n}\n\n"],"mappings":";AAsBO,IAAM,wBAAwB,oBAAI,IAGvC;AAoBF,SAAS,sBAAsB,SAAkB,YAA6B;AAC5E,QAAM,QAAQ,sBAAsB,IAAI,UAAU;AAClD,MAAI,CAAC,OAAO;AACV,WAAO;AAAA,EACT;AACA,QAAM;AACN,SAAO,MAAM,UAAU,MAAM;AAC/B;AAEA,eAAsB,oBAA4C;AAEhE,QAAM,UAAU,MAAM,2BAA2B;AACjD,QAAM,UAAU;AAAA,IACd,WAAW;AAAA,MACT,iBAAiB;AAAA,MACjB,cAAc,IAAI,SAAgB;AAEhC,YAAI,OAAQ,WAAmB,qCAAqC,YAAY;AAC9E,iBAAQ,WAAmB,iCAAiC,GAAG,IAAI;AAAA,QACrE;AACA,cAAM,IAAI,MAAM,gDAAgD;AAAA,MAClE;AAAA,IACF;AAAA,EACF;AACA,SAAO,QAAQ,OAAO;AACxB;AAEA,eAAe,6BAA4D;AAEzE,QAAM,kBAAkB,iBAAiB,KAAK,YAAY,GAAG;AAC7D,QAAM,mBAAmB,kBAAkB,uBAAuB;AAClE,QAAM,aAAa,IAAI,IAAI,kBAAkB,YAAY,GAAG;AAC5D,QAAM,kBAAmB,MAAM,OAAO,WAAW;AAKjD,QAAM,UACJ,gBAAgB,WAAW,gBAAgB,wBAAwB,gBAAgB;AACrF,MAAI,CAAC,SAAS;AACZ,UAAM,IAAI,MAAM,sDAAsD;AAAA,EACxE;AACA,SAAO;AACT;;;ACpFA,IAAM,UAAU,IAAI,YAAY;AAOzB,IAAM,qBAAN,MAAM,oBAAmB;AAAA,EAKtB,YAAY,QAAuB,WAAoB;AAF/D,SAAQ,aAAqB;AAG3B,SAAK,SAAS;AACd,SAAK,YAAY;AAAA,EACnB;AAAA,EAEA,aAAa,OACX,UAAuC,CAAC,GACX;AAC7B,UAAM,gBAAgB,MAAM,kBAAkB;AAC9C,QAAI,QAAQ,sBAAsB,OAAO;AACvC,oBAAc,kBAAkB;AAAA,IAClC;AACA,UAAM,UAAU,IAAI,oBAAmB,eAAe,QAAQ,SAAS;AAGvE,YAAQ,aAAa,cAAc,qBAAqB;AAGxD,0BAAsB,IAAI,QAAQ,YAAY;AAAA,MAC5C,SAAS;AAAA,MACT,OAAO,QAAQ,aAAa;AAAA,IAC9B,CAAC;AAGD,QAAI,QAAQ,cAAc,QAAW;AACnC,oBAAc,mCAAmC,QAAQ,UAAU;AAAA,IACrE;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,gBAA4B;AAC1B,WAAO,KAAK,OAAO;AAAA,EACrB;AAAA,EAEA,eAA2B;AACzB,UAAM,OAAO,KAAK,cAAc;AAChC,UAAM,WAAW,IAAI,WAAW,KAAK,MAAM;AAC3C,aAAS,IAAI,IAAI;AACjB,WAAO;AAAA,EACT;AAAA,EAEA,gBAAgB,UAA4B;AAC1C,UAAM,OAAO,KAAK,cAAc;AAChC,QAAI,SAAS,WAAW,KAAK,QAAQ;AACnC,YAAM,IAAI,MAAM,wBAAwB;AAAA,IAC1C;AACA,SAAK,IAAI,QAAQ;AACjB,QAAI,OAAO,KAAK,OAAO,sBAAsB,YAAY;AACvD,WAAK,OAAO,kBAAkB;AAAA,IAChC;AAAA,EACF;AAAA,EAEA,SAAS,QAAgB,eAAsC;AAC7D,UAAM,EAAE,OAAO,IAAI,KAAK,oBAAoB,QAAQ,aAAa;AACjE,WAAO;AAAA,EACT;AAAA,EAEA,oBAAoB,QAAgB,eAAsE;AAExG,UAAM,QAAQ,sBAAsB,IAAI,KAAK,UAAU;AACvD,QAAI,OAAO;AACT,YAAM,UAAU;AAChB,YAAM,QAAQ,iBAAiB,KAAK,aAAa;AAAA,IACnD;AAEA,UAAM,SAAS,KAAK,iBAAiB,QAAQ,CAAC,KAAK,QAAQ;AACzD,aAAO,KAAK,OAAO,eAAe,KAAK,GAAG;AAAA,IAC5C,CAAC;AAED,UAAM,aAAa,QAAQ,MAAM,UAAU;AAC3C,WAAO,EAAE,QAAQ,WAAW;AAAA,EAC9B;AAAA,EAEA,iBAAiB,cAAsB,MAAsB,eAAsC;AACjG,UAAM,EAAE,OAAO,IAAI,KAAK,4BAA4B,cAAc,MAAM,aAAa;AACrF,WAAO;AAAA,EACT;AAAA,EAEA,4BAA4B,cAAsB,MAAsB,eAAsE;AAE5I,UAAM,QAAQ,sBAAsB,IAAI,KAAK,UAAU;AACvD,QAAI,OAAO;AACT,YAAM,UAAU;AAChB,YAAM,QAAQ,iBAAiB,KAAK,aAAa;AAAA,IACnD;AAEA,UAAM,SAAS,KAAK;AAAA,MAAiB;AAAA,MAAc,CAAC,SAAS,YAC3D,KAAK,OAAO,mBAAmB,SAAS,SAAS,IAAI;AAAA,IACvD;AAEA,UAAM,aAAa,QAAQ,MAAM,UAAU;AAC3C,WAAO,EAAE,QAAQ,WAAW;AAAA,EAC9B;AAAA,EAEQ,iBAAoB,OAAe,IAAwC;AACjF,UAAM,EAAE,KAAK,IAAI,IAAI,KAAK,YAAY,KAAK;AAC3C,QAAI;AACF,aAAO,GAAG,KAAK,GAAG;AAAA,IACpB,UAAE;AACA,WAAK,OAAO,MAAM,GAAG;AAAA,IACvB;AAAA,EACF;AAAA,EAEQ,YAAY,OAA6C;AAC/D,UAAM,QAAQ,QAAQ,OAAO,KAAK;AAClC,UAAM,MAAM,KAAK,OAAO,QAAQ,MAAM,MAAM;AAC5C,SAAK,OAAO,OAAO,IAAI,OAAO,GAAG;AACjC,WAAO,EAAE,KAAK,KAAK,MAAM,OAAO;AAAA,EAClC;AAEF;;;AC5HO,IAAM,oBAAN,MAAM,mBAAwC;AAAA,EAMnD,YAAY,SAA6B,UAA2B,CAAC,GAAG;AALxE,SAAQ,OAAO;AACf,SAAQ,WAAW;AAKjB,SAAK,UAAU;AACf,SAAK,UAAU;AAAA,EACjB;AAAA,EAEA,aAAa,OAAO,UAA2B,CAAC,GAA+B;AAC7E,UAAM,UAAU,MAAM,mBAAmB,OAAO;AAAA,MAC9C,WAAW,QAAQ;AAAA,IACrB,CAAC;AACD,WAAO,IAAI,mBAAkB,SAAS,OAAO;AAAA,EAC/C;AAAA,EAEA,IAAI,aAA4B;AAC9B,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,SAAS,YAAY,CAAkB;AAAA,EAChG;AAAA,EAEA,KAAK,MAAc,SAAqC;AACtD,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,SAAS,MAAM,SAAS,SAAS,CAAC;AAAA,EAC3F;AAAA,EAEA,gBAAgB,MAAc,SAAmC;AAC/D,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,oBAAoB,MAAM,SAAS,SAAS,CAAC;AAAA,EACtG;AAAA,EAEA,aAAa,SAAiB,MAAoC;AAChE,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,iBAAiB,MAAM,IAAI,CAAC;AAAA,EACrF;AAAA,EAEA,wBAAwB,SAAiB,MAAkC;AACzE,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,4BAA4B,MAAM,IAAI,CAAC;AAAA,EAChG;AAAA,EAEA,MAAM,KAAK,SAA4C;AACrD,WAAO,KAAK,yBAAyB,YAAY;AAC/C,YAAM,WAAW,KAAK,QAAQ,aAAa;AAC3C,YAAM,iBAAiB,SAAS,cAAc,SAAY,QAAQ,YAAY,KAAK,QAAQ;AAC3F,YAAM,eAAe,MAAM,mBAAmB,OAAO;AAAA,QACnD,mBAAmB;AAAA,QACnB,WAAW;AAAA,MACb,CAAC;AACD,mBAAa,gBAAgB,QAAQ;AACrC,YAAM,eAAgC;AAAA,QACpC,GAAG,KAAK;AAAA,QACR,WAAW;AAAA,MACb;AACA,aAAO,IAAI,mBAAkB,cAAc,YAAY;AAAA,IACzD,CAAC;AAAA,EACH;AAAA,EAEA,UAAgB;AACd,SAAK,wBAAwB,MAAM;AACjC,WAAK,WAAW;AAAA,IAClB,CAAC;AAAA,EACH;AAAA,EAEA,MAAc,yBAA4B,IAAkC;AAC1E,SAAK,mBAAmB;AACxB,QAAI,KAAK,MAAM;AACb,YAAM,IAAI,MAAM,kCAAkC;AAAA,IACpD;AACA,SAAK,OAAO;AACZ,QAAI;AACF,aAAO,MAAM,GAAG;AAAA,IAClB,UAAE;AACA,WAAK,OAAO;AAAA,IACd;AAAA,EACF;AAAA,EAEQ,wBAA2B,IAAgB;AACjD,SAAK,mBAAmB;AACxB,QAAI,KAAK,MAAM;AACb,YAAM,IAAI,MAAM,kCAAkC;AAAA,IACpD;AACA,SAAK,OAAO;AACZ,QAAI;AACF,aAAO,GAAG;AAAA,IACZ,UAAE;AACA,WAAK,OAAO;AAAA,IACd;AAAA,EACF;AAAA,EAEQ,qBAA2B;AACjC,QAAI,KAAK,UAAU;AACjB,YAAM,IAAI,MAAM,sBAAsB;AAAA,IACxC;AAAA,EACF;AAEF;;;AC1FA,eAAsB,iBAAiB,UAA2B,CAAC,GAAwB;AACzF,SAAO,kBAAkB,OAAO,OAAO;AACzC;AAEA,eAAsB,kBACpB,eACA,UAA2B,CAAC,GACP;AACrB,QAAM,KAAK,MAAM,iBAAiB,OAAO;AACzC,MAAI;AACF,OAAG,KAAK,aAAa;AACrB,WAAO;AAAA,EACT,SAAS,OAAO;AACd,OAAG,QAAQ;AACX,UAAM;AAAA,EACR;AACF;","names":[]}