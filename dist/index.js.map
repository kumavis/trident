{"version":3,"sources":["../src/runtime/loadQuickJsModule.ts","../src/runtime/QuickJsWasmRuntime.ts","../src/vm/QuickJsForkableVm.ts","../src/index.ts"],"sourcesContent":["import type { QuickJsValue } from \"../types.ts\";\n\nexport interface QuickJsModule {\n  HEAP8: Int8Array;\n  HEAPU8: Uint8Array;\n  memory: WebAssembly.Memory;\n  _malloc(size: number): number;\n  _free(ptr: number): void;\n  _qjs_init_runtime(): void;\n  _qjs_eval_utf8(ptr: number, len: number): QuickJsValue;\n  _qjs_call_function(namePtr: number, nameLen: number, args: QuickJsValue[]): QuickJsValue;\n  _qjs_post_restore?(): void;\n}\n\nexport type QuickJsModuleFactory = (imports?: Record<string, unknown>) => Promise<QuickJsModule>;\n\nlet cachedFactoryPromise: Promise<QuickJsModuleFactory> | null = null;\n\nexport async function loadQuickJsModule(): Promise<QuickJsModule> {\n  if (!cachedFactoryPromise) {\n    cachedFactoryPromise = importQuickJsModuleFactory();\n  }\n  const factory = await cachedFactoryPromise;\n  return factory();\n}\n\nasync function importQuickJsModuleFactory(): Promise<QuickJsModuleFactory> {\n  const quickJsUrl = new URL(\"../wasm/quickjs.mjs\", import.meta.url);\n  const moduleNamespace = (await import(quickJsUrl.href)) as {\n    default?: QuickJsModuleFactory;\n    QuickJsModuleFactory?: QuickJsModuleFactory;\n    factory?: QuickJsModuleFactory;\n  };\n  const factory =\n    moduleNamespace.default ?? moduleNamespace.QuickJsModuleFactory ?? moduleNamespace.factory;\n  if (!factory) {\n    throw new Error(\"quickjs.mjs does not export a default module factory\");\n  }\n  return factory;\n}\n\n","import { loadQuickJsModule } from \"./loadQuickJsModule.ts\";\nimport type { QuickJsModule } from \"./loadQuickJsModule.ts\";\nimport type { QuickJsValue } from \"../types.ts\";\n\nconst encoder = new TextEncoder();\n\ninterface QuickJsRuntimeCreateOptions {\n  initializeRuntime?: boolean;\n}\n\nexport class QuickJsWasmRuntime {\n  private readonly module: QuickJsModule;\n\n  private constructor(module: QuickJsModule) {\n    this.module = module;\n  }\n\n  static async create(\n    options: QuickJsRuntimeCreateOptions = {}\n  ): Promise<QuickJsWasmRuntime> {\n    const quickJsModule = await loadQuickJsModule();\n    if (options.initializeRuntime !== false) {\n      quickJsModule._qjs_init_runtime();\n    }\n    return new QuickJsWasmRuntime(quickJsModule);\n  }\n\n  getMemoryView(): Uint8Array {\n    return this.module.HEAPU8;\n  }\n\n  takeSnapshot(): Uint8Array {\n    const view = this.getMemoryView();\n    const snapshot = new Uint8Array(view.length);\n    snapshot.set(view);\n    return snapshot;\n  }\n\n  restoreSnapshot(snapshot: Uint8Array): void {\n    const view = this.getMemoryView();\n    if (snapshot.length !== view.length) {\n      throw new Error(\"Snapshot size mismatch\");\n    }\n    view.set(snapshot);\n    if (typeof this.module._qjs_post_restore === \"function\") {\n      this.module._qjs_post_restore();\n    }\n  }\n\n  evalUtf8(source: string): QuickJsValue {\n    return this.invokeWithString(source, (ptr, len) => {\n      return this.module._qjs_eval_utf8(ptr, len);\n    });\n  }\n\n  callFunctionUtf8(functionName: string, args: QuickJsValue[]): QuickJsValue {\n    return this.invokeWithString(functionName, (namePtr, nameLen) =>\n      this.module._qjs_call_function(namePtr, nameLen, args)\n    );\n  }\n\n  private invokeWithString<T>(value: string, fn: (ptr: number, len: number) => T): T {\n    const { ptr, len } = this.writeString(value);\n    try {\n      return fn(ptr, len);\n    } finally {\n      this.module._free(ptr);\n    }\n  }\n\n  private writeString(value: string): { ptr: number; len: number } {\n    const bytes = encoder.encode(value);\n    const ptr = this.module._malloc(bytes.length);\n    this.module.HEAPU8.set(bytes, ptr);\n    return { ptr, len: bytes.length };\n  }\n\n}\n\n","import { QuickJsWasmRuntime } from \"../runtime/QuickJsWasmRuntime.ts\";\nimport type { CreateVmOptions, ForkableVm, QuickJsObject, QuickJsValue } from \"../types.ts\";\n\nexport class QuickJsForkableVm implements ForkableVm {\n  private busy = false;\n  private disposed = false;\n  private readonly runtime: QuickJsWasmRuntime;\n  private readonly options: CreateVmOptions;\n\n  constructor(runtime: QuickJsWasmRuntime, options: CreateVmOptions = {}) {\n    this.runtime = runtime;\n    this.options = options;\n  }\n\n  static async create(options: CreateVmOptions = {}): Promise<QuickJsForkableVm> {\n    const runtime = await QuickJsWasmRuntime.create();\n    return new QuickJsForkableVm(runtime, options);\n  }\n\n  get globalThis(): QuickJsObject {\n    return this.withExclusiveAccessSync(() => this.runtime.evalUtf8(\"globalThis\") as QuickJsObject);\n  }\n\n  eval(code: string): QuickJsValue {\n    return this.withExclusiveAccessSync(() => this.runtime.evalUtf8(code));\n  }\n\n  callFunction(name: string, ...args: QuickJsValue[]): QuickJsValue {\n    return this.withExclusiveAccessSync(() => this.runtime.callFunctionUtf8(name, args));\n  }\n\n  async fork(): Promise<ForkableVm> {\n    return this.withExclusiveAccessAsync(async () => {\n      const snapshot = this.runtime.takeSnapshot();\n      const childRuntime = await QuickJsWasmRuntime.create({ initializeRuntime: false });\n      childRuntime.restoreSnapshot(snapshot);\n      return new QuickJsForkableVm(childRuntime, this.options);\n    });\n  }\n\n  dispose(): void {\n    this.withExclusiveAccessSync(() => {\n      this.disposed = true;\n    });\n  }\n\n  private async withExclusiveAccessAsync<T>(fn: () => Promise<T>): Promise<T> {\n    this.throwIfUnavailable();\n    if (this.busy) {\n      throw new Error(\"VM operation already in progress\");\n    }\n    this.busy = true;\n    try {\n      return await fn();\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  private withExclusiveAccessSync<T>(fn: () => T): T {\n    this.throwIfUnavailable();\n    if (this.busy) {\n      throw new Error(\"VM operation already in progress\");\n    }\n    this.busy = true;\n    try {\n      return fn();\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  private throwIfUnavailable(): void {\n    if (this.disposed) {\n      throw new Error(\"VM has been disposed\");\n    }\n  }\n\n}\n\n","import { QuickJsForkableVm } from \"./vm/QuickJsForkableVm.ts\";\nimport type { CreateVmOptions, ForkableVm } from \"./types.ts\";\n\nexport { QuickJsWasmRuntime } from \"./runtime/QuickJsWasmRuntime.ts\";\nexport type { QuickJsValue, QuickJsFunction, QuickJsObject, ForkableVm, CreateVmOptions } from \"./types.ts\";\n\nexport async function createForkableVm(options: CreateVmOptions = {}): Promise<ForkableVm> {\n  return QuickJsForkableVm.create(options);\n}\n\nexport async function createPreloadedVm(\n  bootstrapCode: string,\n  options: CreateVmOptions = {}\n): Promise<ForkableVm> {\n  const vm = await createForkableVm(options);\n  try {\n    vm.eval(bootstrapCode);\n    return vm;\n  } catch (error) {\n    vm.dispose();\n    throw error;\n  }\n}\n\n"],"mappings":";AAgBA,IAAI,uBAA6D;AAEjE,eAAsB,oBAA4C;AAChE,MAAI,CAAC,sBAAsB;AACzB,2BAAuB,2BAA2B;AAAA,EACpD;AACA,QAAM,UAAU,MAAM;AACtB,SAAO,QAAQ;AACjB;AAEA,eAAe,6BAA4D;AACzE,QAAM,aAAa,IAAI,IAAI,uBAAuB,YAAY,GAAG;AACjE,QAAM,kBAAmB,MAAM,OAAO,WAAW;AAKjD,QAAM,UACJ,gBAAgB,WAAW,gBAAgB,wBAAwB,gBAAgB;AACrF,MAAI,CAAC,SAAS;AACZ,UAAM,IAAI,MAAM,sDAAsD;AAAA,EACxE;AACA,SAAO;AACT;;;ACnCA,IAAM,UAAU,IAAI,YAAY;AAMzB,IAAM,qBAAN,MAAM,oBAAmB;AAAA,EAGtB,YAAY,QAAuB;AACzC,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,aAAa,OACX,UAAuC,CAAC,GACX;AAC7B,UAAM,gBAAgB,MAAM,kBAAkB;AAC9C,QAAI,QAAQ,sBAAsB,OAAO;AACvC,oBAAc,kBAAkB;AAAA,IAClC;AACA,WAAO,IAAI,oBAAmB,aAAa;AAAA,EAC7C;AAAA,EAEA,gBAA4B;AAC1B,WAAO,KAAK,OAAO;AAAA,EACrB;AAAA,EAEA,eAA2B;AACzB,UAAM,OAAO,KAAK,cAAc;AAChC,UAAM,WAAW,IAAI,WAAW,KAAK,MAAM;AAC3C,aAAS,IAAI,IAAI;AACjB,WAAO;AAAA,EACT;AAAA,EAEA,gBAAgB,UAA4B;AAC1C,UAAM,OAAO,KAAK,cAAc;AAChC,QAAI,SAAS,WAAW,KAAK,QAAQ;AACnC,YAAM,IAAI,MAAM,wBAAwB;AAAA,IAC1C;AACA,SAAK,IAAI,QAAQ;AACjB,QAAI,OAAO,KAAK,OAAO,sBAAsB,YAAY;AACvD,WAAK,OAAO,kBAAkB;AAAA,IAChC;AAAA,EACF;AAAA,EAEA,SAAS,QAA8B;AACrC,WAAO,KAAK,iBAAiB,QAAQ,CAAC,KAAK,QAAQ;AACjD,aAAO,KAAK,OAAO,eAAe,KAAK,GAAG;AAAA,IAC5C,CAAC;AAAA,EACH;AAAA,EAEA,iBAAiB,cAAsB,MAAoC;AACzE,WAAO,KAAK;AAAA,MAAiB;AAAA,MAAc,CAAC,SAAS,YACnD,KAAK,OAAO,mBAAmB,SAAS,SAAS,IAAI;AAAA,IACvD;AAAA,EACF;AAAA,EAEQ,iBAAoB,OAAe,IAAwC;AACjF,UAAM,EAAE,KAAK,IAAI,IAAI,KAAK,YAAY,KAAK;AAC3C,QAAI;AACF,aAAO,GAAG,KAAK,GAAG;AAAA,IACpB,UAAE;AACA,WAAK,OAAO,MAAM,GAAG;AAAA,IACvB;AAAA,EACF;AAAA,EAEQ,YAAY,OAA6C;AAC/D,UAAM,QAAQ,QAAQ,OAAO,KAAK;AAClC,UAAM,MAAM,KAAK,OAAO,QAAQ,MAAM,MAAM;AAC5C,SAAK,OAAO,OAAO,IAAI,OAAO,GAAG;AACjC,WAAO,EAAE,KAAK,KAAK,MAAM,OAAO;AAAA,EAClC;AAEF;;;AC1EO,IAAM,oBAAN,MAAM,mBAAwC;AAAA,EAMnD,YAAY,SAA6B,UAA2B,CAAC,GAAG;AALxE,SAAQ,OAAO;AACf,SAAQ,WAAW;AAKjB,SAAK,UAAU;AACf,SAAK,UAAU;AAAA,EACjB;AAAA,EAEA,aAAa,OAAO,UAA2B,CAAC,GAA+B;AAC7E,UAAM,UAAU,MAAM,mBAAmB,OAAO;AAChD,WAAO,IAAI,mBAAkB,SAAS,OAAO;AAAA,EAC/C;AAAA,EAEA,IAAI,aAA4B;AAC9B,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,SAAS,YAAY,CAAkB;AAAA,EAChG;AAAA,EAEA,KAAK,MAA4B;AAC/B,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,SAAS,IAAI,CAAC;AAAA,EACvE;AAAA,EAEA,aAAa,SAAiB,MAAoC;AAChE,WAAO,KAAK,wBAAwB,MAAM,KAAK,QAAQ,iBAAiB,MAAM,IAAI,CAAC;AAAA,EACrF;AAAA,EAEA,MAAM,OAA4B;AAChC,WAAO,KAAK,yBAAyB,YAAY;AAC/C,YAAM,WAAW,KAAK,QAAQ,aAAa;AAC3C,YAAM,eAAe,MAAM,mBAAmB,OAAO,EAAE,mBAAmB,MAAM,CAAC;AACjF,mBAAa,gBAAgB,QAAQ;AACrC,aAAO,IAAI,mBAAkB,cAAc,KAAK,OAAO;AAAA,IACzD,CAAC;AAAA,EACH;AAAA,EAEA,UAAgB;AACd,SAAK,wBAAwB,MAAM;AACjC,WAAK,WAAW;AAAA,IAClB,CAAC;AAAA,EACH;AAAA,EAEA,MAAc,yBAA4B,IAAkC;AAC1E,SAAK,mBAAmB;AACxB,QAAI,KAAK,MAAM;AACb,YAAM,IAAI,MAAM,kCAAkC;AAAA,IACpD;AACA,SAAK,OAAO;AACZ,QAAI;AACF,aAAO,MAAM,GAAG;AAAA,IAClB,UAAE;AACA,WAAK,OAAO;AAAA,IACd;AAAA,EACF;AAAA,EAEQ,wBAA2B,IAAgB;AACjD,SAAK,mBAAmB;AACxB,QAAI,KAAK,MAAM;AACb,YAAM,IAAI,MAAM,kCAAkC;AAAA,IACpD;AACA,SAAK,OAAO;AACZ,QAAI;AACF,aAAO,GAAG;AAAA,IACZ,UAAE;AACA,WAAK,OAAO;AAAA,IACd;AAAA,EACF;AAAA,EAEQ,qBAA2B;AACjC,QAAI,KAAK,UAAU;AACjB,YAAM,IAAI,MAAM,sBAAsB;AAAA,IACxC;AAAA,EACF;AAEF;;;ACxEA,eAAsB,iBAAiB,UAA2B,CAAC,GAAwB;AACzF,SAAO,kBAAkB,OAAO,OAAO;AACzC;AAEA,eAAsB,kBACpB,eACA,UAA2B,CAAC,GACP;AACrB,QAAM,KAAK,MAAM,iBAAiB,OAAO;AACzC,MAAI;AACF,OAAG,KAAK,aAAa;AACrB,WAAO;AAAA,EACT,SAAS,OAAO;AACd,OAAG,QAAQ;AACX,UAAM;AAAA,EACR;AACF;","names":[]}